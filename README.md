== SPI-Flash IP

=== 1. Описание IP

Таблица 1.2. Порты IP.

[width="80%",cols="15%,85%",options="header",]
|===
|Порт |Описание
|AXI-Lite   |Интерфейс AXI-Lite
|i_dma_clk  |Опорная частота (250МГц)
|i_icap_clk |Частота ICAP (50-100МГц)
|o_spif_cs  |SPI slave select
|u_spif_dq  |INOUT SPI Quad data
|===

=== 2. SPI Flash

Таблица 2.1. Карта регистров.

[cols=",,,",options="header",]
|===
|Адрес |Регистр |Доступ |Описание
|0x00 |PRG_PRM_RW_CTRL |R/W   |Параметры SPI-модуля
|0x04 |PRG_OPR_RW_CTRL |R/W   |Параметры текущей операции
|0x10 |PRG_TRN_RD_STAT |RO    |Состояние Tx FIFO
|0x14 |PRG_TRN_WR_DATA |WO    |Запись данных в Tx FIFO 
|0x20 |PRG_RCV_RD_STAT |RO    |Состояние Rx FIFO
|0x24 |PRG_RCV_RD_DATA |RO    |Чтение данных из Rx FIFO 
|0x30 |PRG_VER_RD_DATA |RO    |Контроль версии протокола SPI-Flash
|===

Таблица 2.2. Описание регистров.

[width="100%",cols="22%,7%,25%,45%",options="header",]
|===
|Регистр            |Бит    |Поле                   |Примечание
|PRG_PRM_RW_CTRL    |26     |SPI FSM Reset          |Программный сброс для «мастера»: 1 – сброс. Поле очищается автоматически, записывать 0 не требуется. Можно применить, если «мастер» занят (поле «SPI Status») дольше некоторого таймаута (например, 10 мс)
|                   |25     |Rx FIFO Reset          |Программный сброс для Rx FIFO: 1 – сброс, поле очищается автоматически
|                   |24     |Tx FIFO Reset          |Программный сброс для Tx FIFO: 1 – сброс, поле очищается автоматически
|                   |20     |SPI Status             |Состояние «мастера»: 1 – занят, 0 – свободен. Нельзя записывать новые команды в регистр 0x04, когда «мастер» занят
|                   |19     |Rx FIFO Full           |Состояние буфера Rx FIFO: 1 – FIFO заполнено, операции с чтением данных по SPI-шине запрещены, нужно прочитать данные из регистра 0x24 или сбросить FIFO для продолжения работы
|                   |18     |Rx FIFO Empty          |Состояние буфера Rx FIFO: 1 – FIFO пустое, нет данных для чтения из регистра 0x24 
|                   |17     |Tx FIFO Full           |Состояние буфера Tx FIFO: 1 – FIFO заполнено, запись в регистр 0x14 запрещена, нужно запустить передачу данных по SPI-шине через регистр 0x04 или сбросить FIFO
|                   |16     |Tx FIFO Empty          |Состояние буфера Tx FIFO: 1 – FIFO пустое, запись команд в регистр 0x04 запрещена
|                   |10     |SPI Protocol           |Протокол SPI: 0 – «Extended» (одна линия на запись, одна на чтение), 1 – «Quad» (4 линии на запись и чтение)
|                   |9      |SPI CPOL               |Полярность SCLK: 0 или 1
|                   |8      |SPI CPHA               |Начальная фаза SCLK: 0 или 1
|                   |7:0    |Sample Rate            |Отношение частоты PCIe (250 МГц) к частоте SCLK пополам, вычисляется по формуле: 
Sample Rate = _F~PCIe~_ / _F~SCLK~_ / 2. Принимает значения от 2 до 255. Если в поле записано запрещённое значение (0 или 1), то SPI-транзакции блокируются, поле возвращает 0 при чтении. По умолчанию поле равно 0
|PRG_OPR_RW_CTRL    |31:20  |Number of Rx Words     |Количество 8-битных слов на чтение по SPI-шине. Принимает значения от 0 до 512. Прочитанные слова записываются в Rx FIFO
|                   |19:12  |Number of Dummy cycles |Количество пустых сэмплов (каждый равен одному периоду SCLK) между записью команды и чтением данных от Flash-памяти. Принимает значения от 0 до 16
|                   |11:0   |Number of Tx Words     |Количество 8-битных слов на запись по SPI-шине. Принимает значения от 0 до 512. Заданное количество слов сперва нужно записать в Tx FIFO
|PRG_TRN_RD_STAT,
PRG_RCV_RD_STAT    a|17     |FIFO Full              |Состояние буфера: 1 – FIFO заполнено, запись запрещена 
|                   |16     |FIFO Empty             |Состояние буфера: 1 – FIFO пустое, чтение запрещено 
|                   |15:0   |FIFO Data counter      |Счётчик 8-битных слов в FIFO
|PRG_TRN_WR_DATA    |31:0   |Tx FIFO Write Data     |Запись 8-битных слов в Tx FIFO для передачи по SPI. Необходимо записывать данные до обращения к регистру 0x04 для запуска транзакции. Перед записью серии слов необходимо проверить состояние FIFO через регистр 0x10. Порядок байт в слове и бит в байте противоположный: старший бит слева, старший байт справа
|PRG_RCV_RD_DATA    |31:0   |Rx FIFO Read Data      |Чтение 8-битных слов из Rx FIFO, принятых по SPI. Перед чтением серии слов необходимо проверить состояние FIFO через регистр 0x20. Порядок байт в слове и бит в байте противоположный: старший бит слева, старший байт справа
|PRG_VER_RD_DATA    |31:24  |Letter «F», ASCII Code |Литера «F» («Flash»), записанная в ASCII коде, поле всегда равно 0x46
|                   |23:16  |Device ID              |Номер устройства, для которого собрана прошивка ПЛИС: 1 – XC7K325TFFG-900-2 (ДМРЛ-3, КММ-1), 2 – XC7K410TFFG-900-2 (РЛК-МЦ «Валдай», РЛС-ОЛП «Алькор») 
|                   |15:8   |Protocol Major Version |Мажорная версия протокола – отмечает изменения, несовместимые с предыдущей версией. Принимает значения от 0 до 255, текущее значение равно 1
|                   |7:0    |Protocol Minor Version |Минорная версия протокола – отмечает добавление функционала без нарушения совместимости. Принимает значения от 0 до 255.
|===    

Регистр 0x00 можно читать и записывать в любое время, но значения из битового диапазона 15:0 применяются только когда «мастер» свободен, чтобы не нарушать текущую операцию.  

Запись любого ненулевого значения в регистр 0x04 запускает транзакцию по SPI-шине. Порядок выполнения операций всегда следующий:
[start=1]
1. Запись (с выхода «мастера» на вход микросхемы), количество 8-битных слов определяется полем «Number of Tx Words».
2. Пустые сэмплы, количество сэмплов определяется полем «Number of Dummy Cycles».
3. Чтение (с выхода микросхемы на вход «мастера»), количество 8-битных слов определяется полем «Number of Rx Words».

Если какие-то операции требуется пропустить – записать 0 в соответствующие поля.

=== 3. ICAP

Примитив ICAP (internal configuration access port) дает доступ к конфигурационной логике ПЛИС через запись команд и чтение данных. С его помощью, например, можно принудительно запустить переинициализацию ПЛИС без сброса питания

Таблица 2.1. Карта регистров.

[cols=",,,",options="header",]
|===
|Адрес |Регистр |Доступ |Описание
|0x40 |ICA_PRM_RW_CTRL |R/W   |Параметры ICAP
|0x44 |ICA_OPR_RW_CTRL |R/W   |Параметры текущей операции
|0x50 |ICA_TRN_RD_STAT |RO    |Состояние Tx FIFO
|0x54 |ICA_TRN_WR_DATA |WO    |Запись данных в Tx FIFO 
|0x58 |ICA_RCV_RD_STAT |RO    |Состояние Rx FIFO
|0x5C |ICA_RCV_RD_DATA |RO    |Чтение данных из Rx FIFO 
|===

Таблица 3.2. Описание регистров.

[width="100%",cols="22%,7%,25%,45%",options="header",]
|===
|Регистр            |Бит    |Поле                   |Примечание
|ICA_PRM_RW_CTRL    |24     |Soft Reset             |Программный сброс для ICAP-интерфейса (как FSM, так и Tx и Rx FIFO): 1 – сброс. Поле очищается автоматически, записывать 0 не требуется. Можно применить для очистки неизвестного содержимого FIFO или если ICAP-интерфейс занят (поле «FSM Status» регистра 0x40) дольше некоторого таймаута (например, 100 мкс). После применения ресета нужно всегда проверять через регистр 0x40, что модуль готов к работе
|                   |20     |FSM Status             |Состояние ICAP-интерфейса: 1 – занят, 0 – свободен. Нельзя записывать новые команды в регистр 0x44, когда ICAP-интерфейс занят
|                   |19     |Rx FIFO Full           |Состояние буфера Rx FIFO: 1 – FIFO заполнено, операции с чтением данных из ICAP запрещены, нужно прочитать данные из регистра 0x5C или сбросить FIFO для продолжения работы
|                   |18     |Rx FIFO Empty          |Состояние буфера Rx FIFO: 1 – FIFO пустое, нет данных для чтения из регистра 0x5C 
|                   |17     |Tx FIFO Full           |Состояние буфера Tx FIFO: 1 – FIFO заполнено, запись в регистр 0x54 запрещена, нужно запустить передачу данных в ICAP через регистр 0x44 или сбросить FIFO
|                   |16     |Tx FIFO Empty          |Состояние буфера Tx FIFO: 1 – FIFO пустое, запись команд в регистр 0x44 запрещена
|ICA_OPR_RW_CTRL    |31:20  |Number of Rx Words     |Количество 32-битных слов на чтение из ICAP. Принимает значения от 0 до 512. Прочитанные слова записываются в Rx FIFO
|                   |11:0   |Number of Tx Words     |Количество 32-битных слов на запись в ICAP. Принимает значения от 0 до 512. Заданное количество слов сперва нужно записать в Tx FIFO
|ICA_TRN_RD_STAT,
ICA_RCV_RD_STAT    a|17     |FIFO Full              |Состояние буфера: 1 – FIFO заполнено, запись запрещена 
|                   |16     |FIFO Empty             |Состояние буфера: 1 – FIFO пустое, чтение запрещено 
|                   |15:0   |FIFO Data counter      |Счётчик 32-битных слов в FIFO
|ICA_TRN_WR_DATA    |31:0   |Tx FIFO Write Data     |Запись 32-битных слов в Tx FIFO для записи в ICAP. Необходимо записывать данные до обращения к регистру 0x44 для запуска транзакции
|PRG_RCV_RD_DATA    |31:0   |Rx FIFO Read Data      |Чтение 32-битных слов из Rx FIFO, принятых из ICAP. Перед чтением серии слов необходимо проверить состояние FIFO через регистр 0x58
|===    

В версии протокола 3.0 в регистр 0x40 можно записать только софтверный ресет, но в нем предусмотрено место (биты 15:0) для дополнительных параметров ICAP-интерфейса

Запись любого ненулевого значения в регистр 0x44 запускает транзакцию между ПЛИС и ICAP. Сперва осуществляется запись команд в ICAP, потом чтение данных из ICAP. Можно использовать только запись или только чтение — эти операции могут быть разбиты на разные транзакции.

=== 4. «Golden» и «Update» образы прошивок ПЛИС

SPI-Flash интерфейс применяется для удалённого обновления прошивки ПЛИС, для этого Flash-память делится на два сегмента. При загрузке прошивки из Flash-памяти ПЛИС сперва обращается к верхнему сегменту, поэтому новая версия прошивки («Update») всегда записывается в верхний сегмент. Если при перезаписи верхнего сегмента произойдёт выключение питания или обрыв связи, то при следующем включении ПЛИС загрузится с нижнего сегмента, и запись в верхний сегмент можно будет повторить. Прошивка для нижнего сегмента («Golden») предназначена только для работы с Flash-памятью.

Таблица 4.1. Структура Flash-памяти.

[width="100%",cols=",,,",options="header",]
|===
|Приоритет при конфигурации ПЛИС|Сегмент памяти| Адресное пространство, байт|Название образа|Назначение
|1|Верхний|0x1000 – 0x1FFF|«Update»|Обычная «рабочая» прошивка с ЦОС
|2|Нижний|0x0000 – 0x0FFF|«Golden»|Только работа с Flash-памятью
|===

Таблица 4.1. Карта регистров «Golden» образа прошивки.

[width="100%",cols="30%,20%,30%,20%",options="header",]
|===
|Название регистра|Адрес|Содержимое|Доступ
|FWR_VER_RD_DATA|0x00 a| * Letter «G», ASCII Code
* Major Version
* Minor Version
* Synth Version| R
|FWR_DAT_RD_DATA|0x004 a| * Year
* Month
* Day| R
|FWR_TME_RD_DATA|0x008 a| * Hour
* Minute
* Second| R
|FWR_HSH_RD_DATA|0x00C a| Firmware Git Hash | R
|BRD_MON_RD_STAT|0x10C a| [0] – Board Power Good Flag | R
|BRD_MON_RD_TEMP|0x110 a| XADC Monitor FPGA Temperature Code R |
|BRD_MON_RD_VINT|0x114 a| XADC Monitor Internal Supply Voltage Code | R
|BRD_MON_RD_VAUX|0x118 a| XADC Monitor Auxiliary Supply Voltage Code | R
|BRD_MON_RD_VRAM|0x11C a| XADC Monitor BRAM Supply Voltage Code | R
|PRG_PRM_RW_CTRL|0xC00 a| * Soft Resets 
* SPI Status and FIFOs’ Flags 
* SPI Protocol and SPI Mode 
* Sample Rate, [2:255] |R/W
|PRG_OPR_RW_CTRL|0xC04 a| * Number of Rx Read Words [0:512] 
* Number of Dummy Cycles [0:63] 
* Number of Tx Write Words [0:512] |R/W
|PRG_TRN_RD_STAT|0xC10 a| * Tx FIFO Full and Empty Flags 
* Tx FIFO Data Counter [0:512] |R
|PRG_TRN_WR_DATA|0xC14 a| Tx FIFO Write Data Bytes 0:3 |W
|PRG_RCV_RD_STAT|0xC20 a| * Rx FIFO Full and Empty Flags 
* Rx FIFO Data Counter [0:512] |R
|PRG_RCV_RD_DATA|0xC24 a| Rx FIFO Read Data Bytes 0:3 |R
|PRG_VER_RD_DATA|0xC30 a| * Letter «F» ASCII Code 
* Device ID 
* Protocol Major Version 
* Protocol Minor Version |R
|ICA_PRM_RW_CTRL|0xC40 a| * FSM Soft Reset 
* FSM Status and FIFOs’ Flags |R/W
|ICA_OPR_RW_CTRL|0xC44 a| * Number of Rx Read Words [0:512] 
* Number of Tx Write Words, [0:512] |R/W
|ICA_TRN_RD_STAT|0xC50 a| * Tx FIFO Full and Empty Flags 
* Tx FIFO Data Counter [0:512] |R
|ICA_TRN_WR_DATA|0xC54 a| Tx FIFO Write Data, 32-bit |W
|ICA_RCV_RD_STAT|0xC58 a| * Rx FIFO Full and Empty Flags 
* Rx FIFO Data Counter [0:512] |R
|ICA_RCV_RD_DATA|0xC5C a| Rx FIFO Read Data, 32-bit |R
|===

=== 5. Примеры операций с Flash-памятью

Записать данные в Flash-память

Структура Flash-памяти:

* страница (256 байт),
* субсектор (16 страниц, 4 КБ),
* сектор (16 субсекторов, 64 КБ),
* весь массив памяти состоит из 512 секторов (32 МБ) – 256 в нижнем сегменте (16 МБ) и 256 в верхнем.

Для примера, пусть требуется стереть первый субсектор и записать 8 байт данных (счетчик от 0x0 до 0xF, по два числа в байте) в третью страницу – порядок действий приведен в таблице 16. Некоторые повторяющиеся действия опущены:

* после записи данных в Tx FIFO (регистр 0xC14) можно проверять счетчик байт (регистр 0xC10),
* перед чтением данных из Rx FIFO (регистр 0xC24) нужно проверять счетчик байт (регистр 0xC20),
* при выполнении долгих операций чтения или записи в Flash-память можно периодически опрашивать состояние «мастера» через регистр 0xC00,
* после выполнения некоторых операций (например, стирания) необходимо выдерживать таймаут, подробности в документации на микросхему.

Таблица 5.1. Запись данных в Flash-память

[width="100%",cols="^5%,^10%,^5%,^13%,50%",options="header",]
|===
|#  |Адрес  |Тип    |Значение   |Описание
|1  |0x00   |W      |0x07000005 |Задать частоту 25 МГц и сбросить все FIFO и автомат «мастера»
|2  |0x00   |R      |0x00050005 |Проверить, что частота принята, FIFO свободны и «мастер» не занят
|3  |0x14   |W     a|

{nbsp} +
{nbsp} +
0x70062000 +
0x00007003 +
0x00020006 +
0x02000200 +
0x01234567 +
0x89ABCDEF +
0x03000200 a|
Последовательно записать в Tx FIFO все команды:

* READ FLAG STATUS REGISTER 0x70
* WRITE ENABLE 0x06
* SUBSECTOR ERASE 0x20, адрес 0x000000
* READ FLAG STATUS REGISTER 0x70
* READ 0x03, адрес 0x000200
* WRITE ENABLE 0x06
* PAGE PROGRAM 0x02, адрес 0x000200, данные 0x01234567 и 0x89ABCDEF
* READ 0x03, адрес 0x000200
|4  |0x04   |W      |0x00400001 |Прочитать FLAG STATUS REGISTER, убедиться, что память можно стирать
|-- |0x24   |R      |0x80808080 | --
|5  |0x04   |W      |0x00000001 | Записать WRITE ENABLE
|6  |0x04   |W      |0x00000004 | Стереть первый субсектор (записать SUBSECTOR ERASE). Подождать время tSSE (до 0,8 с)
|7  |0x04   |W      |0x00400001 | Прочитать FLAG STATUS REGISTER, убедиться, что операция завершена
|-- |0x24   |R      |0x80808080 | -- 
|8  |0x04   |W      |0x00800004 | Записать команду READ и 3-байтный адрес (всего 4 байта), прочитать память (для упрощения только нужные 8 байт, а не весь субсектор), убедиться, что она стёрта
|-- |0x24   |R     a|
0xFFFFFFFF
0xFFFFFFFF | -- 
|9  |0x04   |W      |0x00000001 | Записать WRITE ENABLE
|10 |0x04   |W      |0x0000000С | Записать команду PAGE PROGRAM, 3-байтный адрес и 8 байт данных в память (всего 12 байт)
|11 |0x04   |W      |0x00800004 | Прочитать память, убедиться, что данные записаны
|-- |0x24   |R     a|0x01234567
0x89ABCDEF | --
|===

=== 6. Примеры операций с ICAP

Записать команду IPROG для переинициализации ПЛИС

Команда «Internal PROGRAM» (или «IPROG») запускает бутлоадер ПЛИС, загружающий прошивку из Flash-памяти. Эта операция позволяет не выключать питание платы после перезаписи «Update» образа прошивки и ограничиться перезагрузкой ЭВМ.

Таблица 5.1. Запись данных в Flash-память

[width="100%",cols="^5%,^10%,^5%,^13%,50%",options="header",]
|===
|#  |Адрес  |Тип    |Значение   |Описание
|1  |0x30   |R      |0x460X03XX |Прочитать регистр 0xC30, убедиться, что прошивка поддерживает SPI-Flash и ICAP интерфейс — мажорная версия должна быть равна 3 или выше
|2  |       |--     |--         |Записать новый «Update» образ прошивки в верхний сегмент Flash-памяти
|3  |       |W      |--         |Остановить поток – при переинициализации ПЛИС связь по PCIe будет потеряна, это может привести к зависанию ЭВМ
|4  |0x40   |--     |0x01000000 |аписать "1" в поле "Soft Reset" (бит 24) регистра 0x40, чтобы сбросить ICAP-интерфейс
|5  |0x40   |R      |0x00050000 |Прочитать регистр 0x40, проверить, что Tx и Rx FIFO пусты, модуль не занят
|6  |0x54   |W     a|
{nbsp} +
{nbsp} +
{nbsp} +
0xFFFFFFFF +
0xAA995566 +
0x20000000 +
0x30020001 +
0x00000000 +
0x30008001 +
0x0000000F +
0x20000000 
a|
Последовательно записать в регистр 0xC54 все команды:

* 0xFFFFFFFF — Dummy Words
* 0xAA995566 — Sync Word
* 0x20000000 — Type 1 NO OP (No Operation)
* 0x30020001 — Type 1 Write 1 Words to WBSTAR (Warm Boot Start Address)
* 0x00000000 — Warm Boot Start Address (Load the Desired Address)
* 0x30008001 — Type 1 Write 1 Words to CMD (Command Register)
* 0x0000000F — IPROG Command
* 0x20000000 — Type 1 NO OP
|7  |0x50   |R      |0x00000006 |Прочитать регистр 0x50, проверить, что счетчик данных равен 6
|8  |0x44   |W      |0x00000008 |Записать в регистр 0x44 число 8, чтобы передать в ICAP загруженную в перечислении 6 последовательность из 8 команд
|9  |0x00   |R      |0xFFFFFFFF |Убедиться, что карта регистров всегда возвращает 0xFFFFFFFF (все «1») на чтение (из регистров контроля версий, например)
|10 | --    |--     |--         |Перезагрузить ЭВМ, чтобы восстановить связь по PCIe
|11 |0x00   |R      |0xXXXXXXXX |Запустить конфигуратор и убедиться, что версия прошивки ПЛИС обновилась до загруженной во Flash-память в перечислении 2
|===
