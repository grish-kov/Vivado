# SPI-Flash IP

## 1\. Описание IP

Таблица 1.1. Порты IP.

| Порт         | Описание                 |
| ------------ | ------------------------ |
| AXI-Lite     | Интерфейс AXI-Lite       |
| i\_dma\_clk  | Опорная частота (250МГц) |
| i\_icap\_clk | Частота ICAP (50-100МГц) |
| o\_spif\_cs  | SPI slave select         |
| u\_spif\_dq  | INOUT SPI Quad data      |

## 2\. SPI Flash

Таблица 2.1. Карта регистров.

| Адрес | Регистр            | Доступ | Описание                            |
| ----- | ------------------ | ------ | ----------------------------------- |
| 0x00  | PRG\_PRM\_RW\_CTRL | R/W    | Параметры SPI-модуля                |
| 0x04  | PRG\_OPR\_RW\_CTRL | R/W    | Параметры текущей операции          |
| 0x10  | PRG\_TRN\_RD\_STAT | RO     | Состояние Tx FIFO                   |
| 0x14  | PRG\_TRN\_WR\_DATA | WO     | Запись данных в Tx FIFO             |
| 0x20  | PRG\_RCV\_RD\_STAT | RO     | Состояние Rx FIFO                   |
| 0x24  | PRG\_RCV\_RD\_DATA | RO     | Чтение данных из Rx FIFO            |
| 0x30  | PRG\_VER\_RD\_DATA | RO     | Контроль версии протокола SPI-Flash |

Таблица 2.2. Описание регистров.

| Регистр                                | Бит   | Поле                   | Примечание                                                                                                                                                                                                                                                                                                              |
| -------------------------------------- | ----- | ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| PRG\_PRM\_RW\_CTRL                     | 26    | SPI FSM Reset          | Программный сброс для «мастера»: 1 – сброс. Поле очищается автоматически, записывать 0 не требуется. Можно применить, если «мастер» занят (поле «SPI Status») дольше некоторого таймаута (например, 10 мс)                                                                                                              |
|                                        | 25    | Rx FIFO Reset          | Программный сброс для Rx FIFO: 1 – сброс, поле очищается автоматически                                                                                                                                                                                                                                                  |
|                                        | 24    | Tx FIFO Reset          | Программный сброс для Tx FIFO: 1 – сброс, поле очищается автоматически                                                                                                                                                                                                                                                  |
|                                        | 20    | SPI Status             | Состояние «мастера»: 1 – занят, 0 – свободен. Нельзя записывать новые команды в регистр 0x04, когда «мастер» занят                                                                                                                                                                                                      |
|                                        | 19    | Rx FIFO Full           | Состояние буфера Rx FIFO: 1 – FIFO заполнено, операции с чтением данных по SPI-шине запрещены, нужно прочитать данные из регистра 0x24 или сбросить FIFO для продолжения работы                                                                                                                                         |
|                                        | 18    | Rx FIFO Empty          | Состояние буфера Rx FIFO: 1 – FIFO пустое, нет данных для чтения из регистра 0x24                                                                                                                                                                                                                                       |
|                                        | 17    | Tx FIFO Full           | Состояние буфера Tx FIFO: 1 – FIFO заполнено, запись в регистр 0x14 запрещена, нужно запустить передачу данных по SPI-шине через регистр 0x04 или сбросить FIFO                                                                                                                                                         |
|                                        | 16    | Tx FIFO Empty          | Состояние буфера Tx FIFO: 1 – FIFO пустое, запись команд в регистр 0x04 запрещена                                                                                                                                                                                                                                       |
|                                        | 10    | SPI Protocol           | Протокол SPI: 0 – «Extended» (одна линия на запись, одна на чтение), 1 – «Quad» (4 линии на запись и чтение)                                                                                                                                                                                                            |
|                                        | 9     | SPI CPOL               | Полярность SCLK: 0 или 1                                                                                                                                                                                                                                                                                                |
|                                        | 8     | SPI CPHA               | Начальная фаза SCLK: 0 или 1                                                                                                                                                                                                                                                                                            |
|                                        | 7:0   | Sample Rate            | Отношение частоты PCIe (250 МГц) к частоте SCLK пополам, вычисляется по формуле: Sample Rate = *F<sub>PCIe</sub>* / *F<sub>SCLK</sub>* / 2. Принимает значения от 2 до 255. Если в поле записано запрещённое значение (0 или 1), то SPI-транзакции блокируются, поле возвращает 0 при чтении. По умолчанию поле равно 0 |
| PRG\_OPR\_RW\_CTRL                     | 31:20 | Number of Rx Words     | Количество 8-битных слов на чтение по SPI-шине. Принимает значения от 0 до 512. Прочитанные слова записываются в Rx FIFO                                                                                                                                                                                                |
|                                        | 19:12 | Number of Dummy cycles | Количество пустых сэмплов (каждый равен одному периоду SCLK) между записью команды и чтением данных от Flash-памяти. Принимает значения от 0 до 16                                                                                                                                                                      |
|                                        | 11:0  | Number of Tx Words     | Количество 8-битных слов на запись по SPI-шине. Принимает значения от 0 до 512. Заданное количество слов сперва нужно записать в Tx FIFO                                                                                                                                                                                |
| PRG\_TRN\_RD\_STAT, PRG\_RCV\_RD\_STAT | 17    | FIFO Full              | Состояние буфера: 1 – FIFO заполнено, запись запрещена                                                                                                                                                                                                                                                                  |
|                                        | 16    | FIFO Empty             | Состояние буфера: 1 – FIFO пустое, чтение запрещено                                                                                                                                                                                                                                                                     |
|                                        | 15:0  | FIFO Data counter      | Счётчик 8-битных слов в FIFO                                                                                                                                                                                                                                                                                            |
| PRG\_TRN\_WR\_DATA                     | 31:0  | Tx FIFO Write Data     | Запись 8-битных слов в Tx FIFO для передачи по SPI. Необходимо записывать данные до обращения к регистру 0x04 для запуска транзакции. Перед записью серии слов необходимо проверить состояние FIFO через регистр 0x10. Порядок байт в слове и бит в байте противоположный: старший бит слева, старший байт справа       |
| PRG\_RCV\_RD\_DATA                     | 31:0  | Rx FIFO Read Data      | Чтение 8-битных слов из Rx FIFO, принятых по SPI. Перед чтением серии слов необходимо проверить состояние FIFO через регистр 0x20. Порядок байт в слове и бит в байте противоположный: старший бит слева, старший байт справа                                                                                           |
| PRG\_VER\_RD\_DATA                     | 31:24 | Letter «F», ASCII Code | Литера «F» («Flash»), записанная в ASCII коде, поле всегда равно 0x46                                                                                                                                                                                                                                                   |
|                                        | 23:16 | Device ID              | Номер устройства, для которого собрана прошивка ПЛИС: 1 – XC7K325TFFG-900-2 (ДМРЛ-3, КММ-1), 2 – XC7K410TFFG-900-2 (РЛК-МЦ «Валдай», РЛС-ОЛП «Алькор»)                                                                                                                                                                  |
|                                        | 15:8  | Protocol Major Version | Мажорная версия протокола – отмечает изменения, несовместимые с предыдущей версией. Принимает значения от 0 до 255, текущее значение равно 1                                                                                                                                                                            |
|                                        | 7:0   | Protocol Minor Version | Минорная версия протокола – отмечает добавление функционала без нарушения совместимости. Принимает значения от 0 до 255.                                                                                                                                                                                                |

Регистр 0x00 можно читать и записывать в любое время, но значения из
битового диапазона 15:0 применяются только когда «мастер» свободен,
чтобы не нарушать текущую операцию.

Запись любого ненулевого значения в регистр 0x04 запускает транзакцию по
SPI-шине. Порядок выполнения операций всегда следующий:

1.  Запись (с выхода «мастера» на вход микросхемы), количество 8-битных
    слов определяется полем «Number of Tx Words».

2.  Пустые сэмплы, количество сэмплов определяется полем «Number of
    Dummy Cycles».

3.  Чтение (с выхода микросхемы на вход «мастера»), количество 8-битных
    слов определяется полем «Number of Rx Words».

Если какие-то операции требуется пропустить – записать 0 в
соответствующие поля.

## 3\. ICAP

Примитив ICAP (internal configuration access port) дает доступ к
конфигурационной логике ПЛИС через запись команд и чтение
данных. С его помощью, например, можно принудительно запустить
переинициализацию ПЛИС без сброса питания

Таблица 3.1. Карта регистров.

| Адрес | Регистр            | Доступ | Описание                   |
| ----- | ------------------ | ------ | -------------------------- |
| 0x40  | ICA\_PRM\_RW\_CTRL | R/W    | Параметры ICAP             |
| 0x44  | ICA\_OPR\_RW\_CTRL | R/W    | Параметры текущей операции |
| 0x50  | ICA\_TRN\_RD\_STAT | RO     | Состояние Tx FIFO          |
| 0x54  | ICA\_TRN\_WR\_DATA | WO     | Запись данных в Tx FIFO    |
| 0x58  | ICA\_RCV\_RD\_STAT | RO     | Состояние Rx FIFO          |
| 0x5C  | ICA\_RCV\_RD\_DATA | RO     | Чтение данных из Rx FIFO   |

Таблица 3.2. Описание регистров.

| Регистр                                | Бит   | Поле               | Примечание                                                                                                                                                                                                                                                                                                                                                                                                      |
| -------------------------------------- | ----- | ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ICA\_PRM\_RW\_CTRL                     | 24    | Soft Reset         | Программный сброс для ICAP-интерфейса (как FSM, так и Tx и Rx FIFO): 1 – сброс. Поле очищается автоматически, записывать 0 не требуется. Можно применить для очистки неизвестного содержимого FIFO или если ICAP-интерфейс занят (поле «FSM Status» регистра 0x40) дольше некоторого таймаута (например, 100 мкс). После применения ресета нужно всегда проверять через регистр 0x40, что модуль готов к работе |
|                                        | 20    | FSM Status         | Состояние ICAP-интерфейса: 1 – занят, 0 – свободен. Нельзя записывать новые команды в регистр 0x44, когда ICAP-интерфейс занят                                                                                                                                                                                                                                                                                  |
|                                        | 19    | Rx FIFO Full       | Состояние буфера Rx FIFO: 1 – FIFO заполнено, операции с чтением данных из ICAP запрещены, нужно прочитать данные из регистра 0x5C или сбросить FIFO для продолжения работы                                                                                                                                                                                                                                     |
|                                        | 18    | Rx FIFO Empty      | Состояние буфера Rx FIFO: 1 – FIFO пустое, нет данных для чтения из регистра 0x5C                                                                                                                                                                                                                                                                                                                               |
|                                        | 17    | Tx FIFO Full       | Состояние буфера Tx FIFO: 1 – FIFO заполнено, запись в регистр 0x54 запрещена, нужно запустить передачу данных в ICAP через регистр 0x44 или сбросить FIFO                                                                                                                                                                                                                                                      |
|                                        | 16    | Tx FIFO Empty      | Состояние буфера Tx FIFO: 1 – FIFO пустое, запись команд в регистр 0x44 запрещена                                                                                                                                                                                                                                                                                                                               |
| ICA\_OPR\_RW\_CTRL                     | 31:20 | Number of Rx Words | Количество 32-битных слов на чтение из ICAP. Принимает значения от 0 до 512. Прочитанные слова записываются в Rx FIFO                                                                                                                                                                                                                                                                                           |
|                                        | 11:0  | Number of Tx Words | Количество 32-битных слов на запись в ICAP. Принимает значения от 0 до 512. Заданное количество слов сперва нужно записать в Tx FIFO                                                                                                                                                                                                                                                                            |
| ICA\_TRN\_RD\_STAT, ICA\_RCV\_RD\_STAT | 17    | FIFO Full          | Состояние буфера: 1 – FIFO заполнено, запись запрещена                                                                                                                                                                                                                                                                                                                                                          |
|                                        | 16    | FIFO Empty         | Состояние буфера: 1 – FIFO пустое, чтение запрещено                                                                                                                                                                                                                                                                                                                                                             |
|                                        | 15:0  | FIFO Data counter  | Счётчик 32-битных слов в FIFO                                                                                                                                                                                                                                                                                                                                                                                   |
| ICA\_TRN\_WR\_DATA                     | 31:0  | Tx FIFO Write Data | Запись 32-битных слов в Tx FIFO для записи в ICAP. Необходимо записывать данные до обращения к регистру 0x44 для запуска транзакции                                                                                                                                                                                                                                                                             |
| PRG\_RCV\_RD\_DATA                     | 31:0  | Rx FIFO Read Data  | Чтение 32-битных слов из Rx FIFO, принятых из ICAP. Перед чтением серии слов необходимо проверить состояние FIFO через регистр 0x58                                                                                                                                                                                                                                                                             |

В версии протокола 3.0 в регистр 0x40 можно записать только софтверный
ресет, но в нем предусмотрено место (биты 15:0) для дополнительных
параметров ICAP-интерфейса

Запись любого ненулевого значения в регистр 0x44 запускает транзакцию
между ПЛИС и ICAP. Сперва осуществляется запись команд в ICAP, потом
чтение данных из ICAP. Можно использовать только запись или только
чтение — эти операции могут быть разбиты на разные транзакции.

## 4\. «Golden» и «Update» образы прошивок ПЛИС

SPI-Flash интерфейс применяется для удалённого обновления прошивки ПЛИС,
для этого Flash-память делится на два сегмента. При загрузке прошивки из
Flash-памяти ПЛИС сперва обращается к верхнему сегменту, поэтому новая
версия прошивки («Update») всегда записывается в верхний сегмент. Если
при перезаписи верхнего сегмента произойдёт выключение питания или обрыв
связи, то при следующем включении ПЛИС загрузится с нижнего сегмента, и
запись в верхний сегмент можно будет повторить. Прошивка для нижнего
сегмента («Golden») предназначена только для работы с Flash-памятью.

Таблица 4.1. Структура Flash-памяти.

| Приоритет при конфигурации ПЛИС | Сегмент памяти | Адресное пространство, байт | Название образа | Назначение                       |
| ------------------------------- | -------------- | --------------------------- | --------------- | -------------------------------- |
| 1                               | Верхний        | 0x1000 – 0x1FFF             | «Update»        | Обычная «рабочая» прошивка с ЦОС |
| 2                               | Нижний         | 0x0000 – 0x0FFF             | «Golden»        | Только работа с Flash-памятью    |

Таблица 4.2. Карта регистров «Golden» образа прошивки.

<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 20%" />
<col style="width: 30%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>Название регистра</th>
<th>Адрес</th>
<th>Содержимое</th>
<th>Доступ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>FWR_VER_RD_DATA</p></td>
<td><p>0x00</p></td>
<td><ul>
<li><p>Letter «G», ASCII Code</p></li>
<li><p>Major Version</p></li>
<li><p>Minor Version</p></li>
<li><p>Synth Version</p></li>
</ul></td>
<td><p>R</p></td>
</tr>
<tr class="even">
<td><p>FWR_DAT_RD_DATA</p></td>
<td><p>0x004</p></td>
<td><ul>
<li><p>Year</p></li>
<li><p>Month</p></li>
<li><p>Day</p></li>
</ul></td>
<td><p>R</p></td>
</tr>
<tr class="odd">
<td><p>FWR_TME_RD_DATA</p></td>
<td><p>0x008</p></td>
<td><ul>
<li><p>Hour</p></li>
<li><p>Minute</p></li>
<li><p>Second</p></li>
</ul></td>
<td><p>R</p></td>
</tr>
<tr class="even">
<td><p>FWR_HSH_RD_DATA</p></td>
<td><p>0x00C</p></td>
<td><p>Firmware Git Hash</p></td>
<td><p>R</p></td>
</tr>
<tr class="odd">
<td><p>BRD_MON_RD_STAT</p></td>
<td><p>0x10C</p></td>
<td><p>[0] – Board Power Good Flag</p></td>
<td><p>R</p></td>
</tr>
<tr class="even">
<td><p>BRD_MON_RD_TEMP</p></td>
<td><p>0x110</p></td>
<td><p>XADC Monitor FPGA Temperature Code R</p></td>
<td></td>
</tr>
<tr class="odd">
<td><p>BRD_MON_RD_VINT</p></td>
<td><p>0x114</p></td>
<td><p>XADC Monitor Internal Supply Voltage Code</p></td>
<td><p>R</p></td>
</tr>
<tr class="even">
<td><p>BRD_MON_RD_VAUX</p></td>
<td><p>0x118</p></td>
<td><p>XADC Monitor Auxiliary Supply Voltage Code</p></td>
<td><p>R</p></td>
</tr>
<tr class="odd">
<td><p>BRD_MON_RD_VRAM</p></td>
<td><p>0x11C</p></td>
<td><p>XADC Monitor BRAM Supply Voltage Code</p></td>
<td><p>R</p></td>
</tr>
<tr class="even">
<td><p>PRG_PRM_RW_CTRL</p></td>
<td><p>0xC00</p></td>
<td><ul>
<li><p>Soft Resets</p></li>
<li><p>SPI Status and FIFOs’ Flags</p></li>
<li><p>SPI Protocol and SPI Mode</p></li>
<li><p>Sample Rate, [2:255]</p></li>
</ul></td>
<td><p>R/W</p></td>
</tr>
<tr class="odd">
<td><p>PRG_OPR_RW_CTRL</p></td>
<td><p>0xC04</p></td>
<td><ul>
<li><p>Number of Rx Read Words [0:512]</p></li>
<li><p>Number of Dummy Cycles [0:63]</p></li>
<li><p>Number of Tx Write Words [0:512]</p></li>
</ul></td>
<td><p>R/W</p></td>
</tr>
<tr class="even">
<td><p>PRG_TRN_RD_STAT</p></td>
<td><p>0xC10</p></td>
<td><ul>
<li><p>Tx FIFO Full and Empty Flags</p></li>
<li><p>Tx FIFO Data Counter [0:512]</p></li>
</ul></td>
<td><p>R</p></td>
</tr>
<tr class="odd">
<td><p>PRG_TRN_WR_DATA</p></td>
<td><p>0xC14</p></td>
<td><p>Tx FIFO Write Data Bytes 0:3</p></td>
<td><p>W</p></td>
</tr>
<tr class="even">
<td><p>PRG_RCV_RD_STAT</p></td>
<td><p>0xC20</p></td>
<td><ul>
<li><p>Rx FIFO Full and Empty Flags</p></li>
<li><p>Rx FIFO Data Counter [0:512]</p></li>
</ul></td>
<td><p>R</p></td>
</tr>
<tr class="odd">
<td><p>PRG_RCV_RD_DATA</p></td>
<td><p>0xC24</p></td>
<td><p>Rx FIFO Read Data Bytes 0:3</p></td>
<td><p>R</p></td>
</tr>
<tr class="even">
<td><p>PRG_VER_RD_DATA</p></td>
<td><p>0xC30</p></td>
<td><ul>
<li><p>Letter «F» ASCII Code</p></li>
<li><p>Device ID</p></li>
<li><p>Protocol Major Version</p></li>
<li><p>Protocol Minor Version</p></li>
</ul></td>
<td><p>R</p></td>
</tr>
<tr class="odd">
<td><p>ICA_PRM_RW_CTRL</p></td>
<td><p>0xC40</p></td>
<td><ul>
<li><p>FSM Soft Reset</p></li>
<li><p>FSM Status and FIFOs’ Flags</p></li>
</ul></td>
<td><p>R/W</p></td>
</tr>
<tr class="even">
<td><p>ICA_OPR_RW_CTRL</p></td>
<td><p>0xC44</p></td>
<td><ul>
<li><p>Number of Rx Read Words [0:512]</p></li>
<li><p>Number of Tx Write Words, [0:512]</p></li>
</ul></td>
<td><p>R/W</p></td>
</tr>
<tr class="odd">
<td><p>ICA_TRN_RD_STAT</p></td>
<td><p>0xC50</p></td>
<td><ul>
<li><p>Tx FIFO Full and Empty Flags</p></li>
<li><p>Tx FIFO Data Counter [0:512]</p></li>
</ul></td>
<td><p>R</p></td>
</tr>
<tr class="even">
<td><p>ICA_TRN_WR_DATA</p></td>
<td><p>0xC54</p></td>
<td><p>Tx FIFO Write Data, 32-bit</p></td>
<td><p>W</p></td>
</tr>
<tr class="odd">
<td><p>ICA_RCV_RD_STAT</p></td>
<td><p>0xC58</p></td>
<td><ul>
<li><p>Rx FIFO Full and Empty Flags</p></li>
<li><p>Rx FIFO Data Counter [0:512]</p></li>
</ul></td>
<td><p>R</p></td>
</tr>
<tr class="even">
<td><p>ICA_RCV_RD_DATA</p></td>
<td><p>0xC5C</p></td>
<td><p>Rx FIFO Read Data, 32-bit</p></td>
<td><p>R</p></td>
</tr>
</tbody>
</table>

## 5\. Примеры операций с Flash-памятью

Записать данные в Flash-память

Структура Flash-памяти:

  - страница (256 байт),

  - субсектор (16 страниц, 4 КБ),

  - сектор (16 субсекторов, 64 КБ),

  - весь массив памяти состоит из 512 секторов (32 МБ) – 256 в нижнем
    сегменте (16 МБ) и 256 в верхнем.

Для примера, пусть требуется стереть первый субсектор и записать 8 байт
данных (счетчик от 0x0 до 0xF, по два числа в байте) в третью страницу
– порядок действий приведен в таблице 16. Некоторые повторяющиеся
действия опущены:

  - после записи данных в Tx FIFO (регистр 0xC14) можно проверять
    счетчик байт (регистр 0xC10),

  - перед чтением данных из Rx FIFO (регистр 0xC24) нужно проверять
    счетчик байт (регистр 0xC20),

  - при выполнении долгих операций чтения или записи в Flash-память
    можно периодически опрашивать состояние «мастера» через регистр
    0xC00,

  - после выполнения некоторых операций (например, стирания) необходимо
    выдерживать таймаут, подробности в документации на микросхему.

Таблица 5.1. Запись данных в Flash-память

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 12%" />
<col style="width: 6%" />
<col style="width: 15%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th>#</th>
<th>Адрес</th>
<th>Тип</th>
<th>Значение</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>1</p></td>
<td><p>0x00</p></td>
<td><p>W</p></td>
<td><p>0x07000005</p></td>
<td><p>Задать частоту 25 МГц и сбросить все FIFO и автомат «мастера»</p></td>
</tr>
<tr class="even">
<td><p>2</p></td>
<td><p>0x00</p></td>
<td><p>R</p></td>
<td><p>0x00050005</p></td>
<td><p>Проверить, что частота принята, FIFO свободны и «мастер» не занят</p></td>
</tr>
<tr class="odd">
<td><p>3</p></td>
<td><p>0x14</p></td>
<td><p>W</p></td>
<td><p> <br />
 <br />
0x70062000<br />
0x00007003<br />
0x00020006<br />
0x02000200<br />
0x01234567<br />
0x89ABCDEF<br />
0x03000200</p></td>
<td><p>Последовательно записать в Tx FIFO все команды:</p>
<ul>
<li><p>READ FLAG STATUS REGISTER 0x70</p></li>
<li><p>WRITE ENABLE 0x06</p></li>
<li><p>SUBSECTOR ERASE 0x20, адрес 0x000000</p></li>
<li><p>READ FLAG STATUS REGISTER 0x70</p></li>
<li><p>READ 0x03, адрес 0x000200</p></li>
<li><p>WRITE ENABLE 0x06</p></li>
<li><p>PAGE PROGRAM 0x02, адрес 0x000200, данные 0x01234567 и 0x89ABCDEF</p></li>
<li><p>READ 0x03, адрес 0x000200</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p>4</p></td>
<td><p>0x04</p></td>
<td><p>W</p></td>
<td><p>0x00400001</p></td>
<td><p>Прочитать FLAG STATUS REGISTER, убедиться, что память можно стирать</p></td>
</tr>
<tr class="odd">
<td><p> — </p></td>
<td><p>0x24</p></td>
<td><p>R</p></td>
<td><p>0x80808080</p></td>
<td><p> — </p></td>
</tr>
<tr class="even">
<td><p>5</p></td>
<td><p>0x04</p></td>
<td><p>W</p></td>
<td><p>0x00000001</p></td>
<td><p>Записать WRITE ENABLE</p></td>
</tr>
<tr class="odd">
<td><p>6</p></td>
<td><p>0x04</p></td>
<td><p>W</p></td>
<td><p>0x00000004</p></td>
<td><p>Стереть первый субсектор (записать SUBSECTOR ERASE). Подождать время tSSE (до 0,8 с)</p></td>
</tr>
<tr class="even">
<td><p>7</p></td>
<td><p>0x04</p></td>
<td><p>W</p></td>
<td><p>0x00400001</p></td>
<td><p>Прочитать FLAG STATUS REGISTER, убедиться, что операция завершена</p></td>
</tr>
<tr class="odd">
<td><p> — </p></td>
<td><p>0x24</p></td>
<td><p>R</p></td>
<td><p>0x80808080</p></td>
<td><p> — </p></td>
</tr>
<tr class="even">
<td><p>8</p></td>
<td><p>0x04</p></td>
<td><p>W</p></td>
<td><p>0x00800004</p></td>
<td><p>Записать команду READ и 3-байтный адрес (всего 4 байта), прочитать память (для упрощения только нужные 8 байт, а не весь субсектор), убедиться, что она стёрта</p></td>
</tr>
<tr class="odd">
<td><p> — </p></td>
<td><p>0x24</p></td>
<td><p>R</p></td>
<td><p>0xFFFFFFFF 0xFFFFFFFF</p></td>
<td><p> — </p></td>
</tr>
<tr class="even">
<td><p>9</p></td>
<td><p>0x04</p></td>
<td><p>W</p></td>
<td><p>0x00000001</p></td>
<td><p>Записать WRITE ENABLE</p></td>
</tr>
<tr class="odd">
<td><p>10</p></td>
<td><p>0x04</p></td>
<td><p>W</p></td>
<td><p>0x0000000С</p></td>
<td><p>Записать команду PAGE PROGRAM, 3-байтный адрес и 8 байт данных в память (всего 12 байт)</p></td>
</tr>
<tr class="even">
<td><p>11</p></td>
<td><p>0x04</p></td>
<td><p>W</p></td>
<td><p>0x00800004</p></td>
<td><p>Прочитать память, убедиться, что данные записаны</p></td>
</tr>
<tr class="odd">
<td><p> — </p></td>
<td><p>0x24</p></td>
<td><p>R</p></td>
<td><p>0x01234567 0x89ABCDEF</p></td>
<td><p> — </p></td>
</tr>
</tbody>
</table>

## 6\. Примеры операций с ICAP

Записать команду IPROG для переинициализации ПЛИС

Команда «Internal PROGRAM» (или «IPROG») запускает бутлоадер ПЛИС,
загружающий прошивку из Flash-памяти. Эта операция позволяет не
выключать питание платы после перезаписи «Update» образа прошивки и
ограничиться перезагрузкой ЭВМ.

Таблица 6.1. Запись данных в Flash-память

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 12%" />
<col style="width: 6%" />
<col style="width: 15%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th>#</th>
<th>Адрес</th>
<th>Тип</th>
<th>Значение</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>1</p></td>
<td><p>0x30</p></td>
<td><p>R</p></td>
<td><p>0x460X03XX</p></td>
<td><p>Прочитать регистр 0xC30, убедиться, что прошивка поддерживает SPI-Flash и ICAP интерфейс — мажорная версия должна быть равна 3 или выше</p></td>
</tr>
<tr class="even">
<td><p>2</p></td>
<td></td>
<td><p> — </p></td>
<td><p> — </p></td>
<td><p>Записать новый «Update» образ прошивки в верхний сегмент Flash-памяти</p></td>
</tr>
<tr class="odd">
<td><p>3</p></td>
<td></td>
<td><p>W</p></td>
<td><p> — </p></td>
<td><p>Остановить поток – при переинициализации ПЛИС связь по PCIe будет потеряна, это может привести к зависанию ЭВМ</p></td>
</tr>
<tr class="even">
<td><p>4</p></td>
<td><p>0x40</p></td>
<td><p> — </p></td>
<td><p>0x01000000</p></td>
<td><p>аписать "1" в поле "Soft Reset" (бит 24) регистра 0x40, чтобы сбросить ICAP-интерфейс</p></td>
</tr>
<tr class="odd">
<td><p>5</p></td>
<td><p>0x40</p></td>
<td><p>R</p></td>
<td><p>0x00050000</p></td>
<td><p>Прочитать регистр 0x40, проверить, что Tx и Rx FIFO пусты, модуль не занят</p></td>
</tr>
<tr class="even">
<td><p>6</p></td>
<td><p>0x54</p></td>
<td><p>W</p></td>
<td><p> <br />
 <br />
 <br />
0xFFFFFFFF<br />
0xAA995566<br />
0x20000000<br />
0x30020001<br />
0x00000000<br />
0x30008001<br />
0x0000000F<br />
0x20000000</p></td>
<td><p>Последовательно записать в регистр 0xC54 все команды:</p>
<ul>
<li><p>0xFFFFFFFF — Dummy Words</p></li>
<li><p>0xAA995566 — Sync Word</p></li>
<li><p>0x20000000 — Type 1 NO OP (No Operation)</p></li>
<li><p>0x30020001 — Type 1 Write 1 Words to WBSTAR (Warm Boot Start Address)</p></li>
<li><p>0x00000000 — Warm Boot Start Address (Load the Desired Address)</p></li>
<li><p>0x30008001 — Type 1 Write 1 Words to CMD (Command Register)</p></li>
<li><p>0x0000000F — IPROG Command</p></li>
<li><p>0x20000000 — Type 1 NO OP</p></li>
</ul></td>
</tr>
<tr class="odd">
<td><p>7</p></td>
<td><p>0x50</p></td>
<td><p>R</p></td>
<td><p>0x00000006</p></td>
<td><p>Прочитать регистр 0x50, проверить, что счетчик данных равен 6</p></td>
</tr>
<tr class="even">
<td><p>8</p></td>
<td><p>0x44</p></td>
<td><p>W</p></td>
<td><p>0x00000008</p></td>
<td><p>Записать в регистр 0x44 число 8, чтобы передать в ICAP загруженную в перечислении 6 последовательность из 8 команд</p></td>
</tr>
<tr class="odd">
<td><p>9</p></td>
<td><p>0x00</p></td>
<td><p>R</p></td>
<td><p>0xFFFFFFFF</p></td>
<td><p>Убедиться, что карта регистров всегда возвращает 0xFFFFFFFF (все «1») на чтение (из регистров контроля версий, например)</p></td>
</tr>
<tr class="even">
<td><p>10</p></td>
<td><p> — </p></td>
<td><p> — </p></td>
<td><p> — </p></td>
<td><p>Перезагрузить ЭВМ, чтобы восстановить связь по PCIe</p></td>
</tr>
<tr class="odd">
<td><p>11</p></td>
<td><p>0x00</p></td>
<td><p>R</p></td>
<td><p>0xXXXXXXXX</p></td>
<td><p>Запустить конфигуратор и убедиться, что версия прошивки ПЛИС обновилась до загруженной во Flash-память в перечислении 2</p></td>
</tr>
</tbody>
</table>
